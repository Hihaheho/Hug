<html>
  <head>
    <meta charset="UTF-8" />
    <style>
      html, body {
        padding: 0px;
        margin: 0px;
        touch-action: none;
      }
      body {
        z-index: 1;
      }
			canvas {
        position: absolute;
				width: 100% !important;
				height: 100% !important;
        z-index: 2;
			}
      #buttons {
        position: absolute;
        z-index: 3;
        width: 100%;
      }
      button {
        font-size: 2.5em;
        width: 30%;
      }
      #message, #alert {
        font-size: 2.5em;
      }
      #name {
        font-size: 2.5em;
        width: 30%;
      }
    </style>
  </head>

  <body>
		<div id="iphone">
			<p>If you're using Safari on iPhone, please google how to enable WebGL2.0 on iPhone.</p>
			<p>iPhoneのSafariをお使いの方は、「iPhoneでWebGL2.0を有効にする方法」でググってください。</p>
		</div>
    <div id="buttons">
      <button id="random">Random</button>
      <button id="room">New Room</button>
      <input id="name" type="text" placeholder="Name" />
      <p id="message"></p>
      <p id="alert"></p>
    </div>
  </body>

  <script type="module">
    import init, {on_output, on_name_change} from './hug.js'
    import { Socket } from "./phoenix.esm.js"

    let socket;
    let params = new URLSearchParams(window.location.search);
    if (params.get("local")) {
      socket = new Socket("ws://localhost:4000/socket", {params: {}})
    } else {
      socket = new Socket("wss://server.hug.hihaheho.com/socket", {params: {}})
    }
    socket.connect()
    let channel = socket.channel("player", {})
    channel.join()
      .receive("ok", resp => { console.log("Joined successfully", resp) })
      .receive("error", resp => { console.log("Unable to join", resp) })

    // register event handlers for input/output.
    document.push = payload => channel.push("input", JSON.parse(payload));
    channel.on("output", payload => {
      on_output(JSON.stringify(payload))
    });

    // join room by key
    if (params.get("key")) {
      window.localStorage.setItem("key", params.get("key"));
    } else {
      window.localStorage.removeItem("key");
    }

    document.querySelector("#random").onclick = () =>
      window.localStorage.setItem("random", "true");
    document.querySelector("#room").onclick = () =>
      window.localStorage.setItem("room", "true");
    document.querySelector("#name").oninput = (event) =>
      on_name_change(event.target.value);

    init()
  </script>
</html>
